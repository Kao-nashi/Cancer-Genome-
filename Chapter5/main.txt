# 解析環境の準備
# Miniconda
cd ~
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
export PATH=~/miniconda3/bin:$PATH
conda update --all

# 作業用のディレクトリ（~/analysis）を作成し、ファイルを設置する。
cd ~
mkdir -p analysis
cd ~/analysis
wget https://kero.hgc.jp/cgi-bin/download/long_read/adenocarcinoma_cell_lines/genome/promethion/RERF-LC-MS/1d.fq.gz 
conda install -c bioconda seqkit
seqkit stats 1d.fq.gz

# 解析①：構造変異検出
# ツールの準備
conda install -c bioconda minimap2
minimap2
conda install -c bioconda samtools
samtools
cd ~/miniconda3/lib
ln –s libcrypto.so.1.1 libcrypto.so.1.0.0
pip install nanomonsv
nanomonsv -h
conda install -c bioconda pysam
conda install -c bioconda parasail-python
conda install -c bioconda htslib
conda install -c bioconda mafft
conda install -c bioconda racon
conda install -c bioconda bwa
conda install repeatmasker
conda install -c bioconda bedtools
pip install annot_utils
conda install -c bioconda snpeff
snpEff
wget https://data.broadinstitute.org/igv/projects/downloads/2.9/IGV_Linux_2.9.4_WithJava.zip
unzip IGV_Linux_2.9.4_WithJava.zip
cd IGV_Linux_2.9.4/
sh ./igv.sh

# 参照ゲノム配列の準備
cd ~/analysis
wget http://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.chromFa.tar.gz
tar -xf hg38.chromFa.tar.gz
for i in {1..22} X Y M; do cat chroms/chr${i}.fa >> hg38.fa; done
minimap2 -d hg38.mmi hg38.fa
bwa index -a bwtsw -p hg38.fa hg38.fa

# マッピング
minimap2 -ax map-ont --MD -t 5 hg38.mmi 1d.fq.gz | \
 samtools view -bS -@5 | \
 samtools sort -@5 -o RERF-LC-MS_sorted.bam
samtools index RERF-LC-MS_sorted.bam

# NanomonsvによるSV検出
nanomonsv parse RERF-LC-MS_sorted.bam RERF-LC-MS
ls -lh | grep gz | grep RERF-LC-MS
nanomonsv get RERF-LC-MS RERF-LC-MS_sorted.bam \
 hg38.fa --use_racon
cat RERF-LC-MS.nanomonsv.result.txt | grep PASS | wc -l
wget https://raw.githubusercontent.com/friend1ws/nanomonsv/master/misc/sv_type.py
python sv_type.py RERF-LC-MS.nanomonsv.result.txt RERF-LC-MS.nanomonsv.result_svtype.txt
cat RERF-LC-MS.nanomonsv.result_svtype.txt | grep PASS | grep Insertion | wc -l
cat RERF-LC-MS.nanomonsv.result_svtype.txt | grep PASS | grep Deletion | wc -l
cat RERF-LC-MS.nanomonsv.result_svtype.txt | grep PASS | grep Duplication | wc -l
cat RERF-LC-MS.nanomonsv.result_svtype.txt | grep PASS | grep Inversion | wc -l
cat RERF-LC-MS.nanomonsv.result_svtype.txt | grep PASS | grep Translocation | wc -l
export BLASTDB_LMDB_MAP_SIZE=1000000
nanomonsv insert_classify \
 --genome_id hg38 \
 RERF-LC-MS.nanomonsv.result_svtype.txt \
 RERF-LC-MS.nanomonsv.result_insert_classify.txt \
 hg38.fa
less RERF-LC-MS.nanomonsv.result_insert_classify.txt

nanomonsv parse Normal_sorted.bam Normal
nanomonsv parse Tumor_sorted.bam Tumor
nanomonsv get Tumor Tumor_sorted.bam \
 --control_prefix Normal --control_bam Normal_sorted.bam \
 hg38.fa --use_racon

# アノテーション
snpEff databases | grep GRCh38
snpEff download -v GRCh38.99 -c ~/miniconda3/share/snpeff-5.0-1/snpEff.config
export _JAVA_OPTIONS='-XX:+UseSerialGC -Xmx5g -Xms1g'
snpEff GRCh38.99 RERF-LC-MS.nanomonsv.result.vcf > RERF-LC-MS.nanomonsv.result.snpeff.vcf
cat RERF-LC-MS.nanomonsv.result.snpeff.vcf | grep PASS | grep protein_coding | less

# 可視化
cd IGV_Linux_2.9.4/
sh ./igv.sh

# ②：フェージング解析
# ツールの準備





